name: Build EasyClick Agent Complete

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Reassemble iosauto Framework
      run: |
        echo "üîß ÈáçÁªÑiosauto.framework..."
        
        # Ê£ÄÊü•ÂàÜÁâáÊñá‰ª∂
        if [ ! -f "iosauto_part_0" ] || [ ! -f "iosauto_part_1" ] || [ ! -f "iosauto_part_2" ]; then
            echo "‚ùå Áº∫Â∞ëÂàÜÁâáÊñá‰ª∂"
            exit 1
        fi
        
        echo "‚úÖ ÊâæÂà∞ÊâÄÊúâÂàÜÁâáÊñá‰ª∂"
        ls -la iosauto_part_*
        
        # ÈáçÁªÑ‰∫åËøõÂà∂Êñá‰ª∂
        cat iosauto_part_0 iosauto_part_1 iosauto_part_2 > iosauto_reassembled
        
        # È™åËØÅÊñá‰ª∂Â§ßÂ∞è
        original_size=14114144
        reassembled_size=$(stat -f%z "iosauto_reassembled" 2>/dev/null || stat -c%s "iosauto_reassembled")
        
        echo "üìä Êñá‰ª∂Â§ßÂ∞èÊ£ÄÊü•Ôºö"
        echo "  ÂéüÂßã: $original_size Â≠óËäÇ"
        echo "  ÈáçÁªÑ: $reassembled_size Â≠óËäÇ"
        
        if [ "$reassembled_size" -ne "$original_size" ]; then
            echo "‚ùå Êñá‰ª∂Â§ßÂ∞è‰∏çÂåπÈÖç"
            exit 1
        fi
        
        echo "‚úÖ ÈáçÁªÑÊàêÂäüÔºÅ"
        
        # ÂàõÂª∫frameworkÁªìÊûÑ
        mkdir -p iosauto.framework
        mv iosauto_reassembled iosauto.framework/iosauto
        chmod +x iosauto.framework/iosauto
        
        # ÂàõÂª∫Info.plist
        cat > iosauto.framework/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleIdentifier</key>
            <string>com.easyclick.iosauto</string>
            <key>CFBundleName</key>
            <string>iosauto</string>
            <key>CFBundleVersion</key>
            <string>5.12.0</string>
            <key>CFBundlePackageType</key>
            <string>FMWK</string>
        </dict>
        </plist>
        EOF
        
        # ÂàõÂª∫Âü∫Êú¨Headers
        mkdir -p iosauto.framework/Headers
        cat > iosauto.framework/Headers/iosauto.h << 'EOF'
        #import <Foundation/Foundation.h>
        
        @interface IOSAuto : NSObject
        + (instancetype)sharedInstance;
        @end
        EOF
        
        echo "üìÅ FrameworkÁªìÊûÑÂàõÂª∫ÂÆåÊàêÔºö"
        find iosauto.framework -type f
        
    - name: Build Complete EasyClick Agent
      run: |
        echo "üî® ‰ΩøÁî®ÂÆåÊï¥frameworkÁºñËØëEasyClick Agent..."
        
        # Ê£ÄÊü•ÊòØÂê¶Êúâbuildipa.sh
        if [ -f "buildipa.sh" ]; then
            echo "‚úÖ ÂèëÁé∞buildipa.shÔºå‰ΩøÁî®ÂéüÁîüÊûÑÂª∫"
            chmod +x buildipa.sh
            
            # ‰øÆÊîπbuildipa.sh‰ª•ÈÄÇÂ∫îÂΩìÂâçÁéØÂ¢É
            if grep -q "ipaPath=" buildipa.sh; then
                sed -i.bak 's|ipaPath=.*|ipaPath="EasyClickAgent-Complete.ipa"|' buildipa.sh
            fi
            
            # ÊâßË°åÊûÑÂª∫
            ./buildipa.sh || echo "buildipa.shÊâßË°åÂÆåÊàê"
            
            # Ê£ÄÊü•ÊòØÂê¶ÁîüÊàê‰∫ÜIPA
            if [ -f "EasyClickAgent-Complete.ipa" ]; then
                echo "‚úÖ ÂéüÁîüÊûÑÂª∫ÊàêÂäü"
                ls -lh EasyClickAgent-Complete.ipa
            else
                echo "‚ö†Ô∏è ÂéüÁîüÊûÑÂª∫Êú™ÁîüÊàêIPAÔºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à"
            fi
        fi
        
        # Â§áÁî®ÊûÑÂª∫ÊñπÊ°à
        if [ ! -f "EasyClickAgent-Complete.ipa" ]; then
            echo "üîß ‰ΩøÁî®Â§áÁî®ÊûÑÂª∫ÊñπÊ°à..."
            
            # ÂàõÂª∫Â∫îÁî®ÁõÆÂΩï
            mkdir -p Payload/EasyClickAgent.app
            
            # ÂàõÂª∫Â∫îÁî®Info.plist
            cat > Payload/EasyClickAgent.app/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleIdentifier</key>
            <string>com.easyclick.agent.complete</string>
            <key>CFBundleName</key>
            <string>EasyClick Agent</string>
            <key>CFBundleDisplayName</key>
            <string>EasyClick Agent Complete</string>
            <key>CFBundleVersion</key>
            <string>5.12.0</string>
            <key>CFBundleShortVersionString</key>
            <string>5.12.0</string>
            <key>CFBundleExecutable</key>
            <string>EasyClickAgent</string>
            <key>UIRequiredDeviceCapabilities</key>
            <array>
                <string>arm64</string>
            </array>
            <key>UIBackgroundModes</key>
            <array>
                <string>background-fetch</string>
                <string>background-processing</string>
                <string>external-accessory</string>
            </array>
            <key>LSRequiresIPhoneOS</key>
            <true/>
        </dict>
        </plist>
        EOF
            
            # Â§çÂà∂frameworkÂà∞Â∫îÁî®ÂåÖ
            cp -r iosauto.framework Payload/EasyClickAgent.app/
            
            # Â§çÂà∂ÂÖ∂‰ªñÈáçË¶ÅÊñá‰ª∂
            if [ -d "WebDriverAgentRunner" ]; then
                find WebDriverAgentRunner -
