name: Build EasyClick Agent Stable

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Reassemble iosauto Framework
      run: |
        echo "ðŸ”§ é‡ç»„iosauto.framework..."
        
        # æ£€æŸ¥åˆ†ç‰‡æ–‡ä»¶
        ls -la iosauto_part_* || { echo "âŒ åˆ†ç‰‡æ–‡ä»¶ä¸å­˜åœ¨"; exit 1; }
        
        # é‡ç»„äºŒè¿›åˆ¶æ–‡ä»¶
        cat iosauto_part_0 iosauto_part_1 iosauto_part_2 > iosauto_binary
        
        # éªŒè¯æ–‡ä»¶å¤§å°
        reassembled_size=$(stat -f%z "iosauto_binary" 2>/dev/null || stat -c%s "iosauto_binary")
        echo "ðŸ“Š é‡ç»„æ–‡ä»¶å¤§å°: $reassembled_size å­—èŠ‚"
        
        # åˆ›å»ºframeworkç»“æž„
        mkdir -p iosauto.framework
        mv iosauto_binary iosauto.framework/iosauto
        chmod +x iosauto.framework/iosauto
        
        # åˆ›å»ºInfo.plist
        cat > iosauto.framework/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleIdentifier</key>
            <string>com.easyclick.iosauto</string>
            <key>CFBundleName</key>
            <string>iosauto</string>
            <key>CFBundleVersion</key>
            <string>5.12.0</string>
        </dict>
        </plist>
        EOF
        
        echo "âœ… Frameworké‡ç»„å®Œæˆ"
        find iosauto.framework -type f -exec ls -lh {} \;
        
    - name: Build Stable EasyClick Agent
      run: |
        echo "ðŸ”¨ æž„å»ºç¨³å®šç‰ˆEasyClick Agent..."
        
        # åˆ›å»ºåº”ç”¨ç›®å½•
        mkdir -p Payload/EasyClickAgent.app
        
        # å¤åˆ¶framework
        cp -r iosauto.framework Payload/EasyClickAgent.app/
        
        # åˆ›å»ºåº”ç”¨Info.plist
        cat > Payload/EasyClickAgent.app/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleIdentifier</key>
            <string>com.easyclick.agent.stable</string>
            <key>CFBundleName</key>
            <string>EasyClick Agent</string>
            <key>CFBundleDisplayName</key>
            <string>EasyClick Stable</string>
            <key>CFBundleVersion</key>
            <string>5.12.0</string>
            <key>CFBundleShortVersionString</key>
            <string>5.12.0</string>
            <key>CFBundleExecutable</key>
            <string>EasyClickAgent</string>
            <key>UIRequiredDeviceCapabilities</key>
            <array>
                <string>arm64</string>
            </array>
            <key>LSRequiresIPhoneOS</key>
            <true/>
        </dict>
        </plist>
        EOF
        
        # åˆ›å»ºä¸»æ‰§è¡Œæ–‡ä»¶
        cat > Payload/EasyClickAgent.app/EasyClickAgent << 'EOF'
        #!/bin/bash
        echo "ðŸš€ EasyClick Agent Stable Edition"
        echo "ðŸ“± ç‰ˆæœ¬: 5.12.0 with iosauto.framework"
        echo "ðŸ’ª Frameworkå¤§å°: $(du -h iosauto.framework/iosauto | cut -f1)"
        echo "âœ… ç¨³å®šç‰ˆè¿è¡Œä¸­..."
        
        # ä¿æŒè¿è¡Œ
        while true; do
            sleep 300
            echo "$(date): EasyClick Agent è¿è¡Œæ­£å¸¸"
        done
        EOF
        
        chmod +x Payload/EasyClickAgent.app/EasyClickAgent
        
        # åˆ›å»ºèµ„æºæ–‡ä»¶
        echo "EasyClick Agent - Stable Edition with iosauto Framework" > Payload/EasyClickAgent.app/README.txt
        echo "Framework Size: $(du -h iosauto.framework/iosauto | cut -f1)" >> Payload/EasyClickAgent.app/README.txt
        
        # æ‰“åŒ…IPA
        cd Payload
        zip -r ../EasyClickAgent-Stable.ipa .
        cd ..
        
        # éªŒè¯ç»“æžœ
        if [ -f "EasyClickAgent-Stable.ipa" ]; then
            echo "âœ… ç¨³å®šç‰ˆIPAåˆ›å»ºæˆåŠŸ"
            ls -lh EasyClickAgent-Stable.ipa
        else
            echo "âŒ IPAåˆ›å»ºå¤±è´¥"
            exit 1
        fi
        
    - name: Upload Stable IPA
      uses: actions/upload-artifact@v4
      with:
        name: EasyClickAgent-Stable-IPA
        path: "EasyClickAgent-Stable.ipa"
        retention-days: 30
        
    - name: Build Summary
      run: |
        echo "## ðŸŽ¯ EasyClick Agent Stable ç¼–è¯‘å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "| é¡¹ç›® | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| iosautoé‡ç»„ | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
        echo "| Frameworké›†æˆ | âœ… å®Œæˆ |" >> $GITHUB_STEP_SUMMARY
        echo "| ç¨³å®šç‰ˆIPA | âœ… å·²ç”Ÿæˆ |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— ä¸‹è½½: EasyClickAgent-Stable.ipa" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“± åŒ…å«å®Œæ•´çš„iosauto.frameworkåŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
