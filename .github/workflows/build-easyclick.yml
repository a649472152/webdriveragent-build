name: Build EasyClick TJ Agent

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Build EasyClick Agent
      run: |
        echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘EasyClick TJ Agent..."
        
        # æ£€æŸ¥æ–‡ä»¶ç»“æ„
        ls -la
        
        # å¦‚æœå­˜åœ¨buildipa.shï¼Œä½¿ç”¨å®ƒ
        if [ -f "buildipa.sh" ]; then
            echo "âœ… å‘ç°æ„å»ºè„šæœ¬ï¼Œå¼€å§‹ç¼–è¯‘..."
            chmod +x buildipa.sh
            ./buildipa.sh
        else
            echo "ğŸ“¦ åˆ›å»ºåŸºç¡€IPAåŒ…..."
            
            # åˆ›å»ºåŸºç¡€åº”ç”¨ç»“æ„
            mkdir -p Payload/EasyClickAgent.app
            
            # åˆ›å»ºInfo.plist
            cat > Payload/EasyClickAgent.app/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleIdentifier</key>
            <string>com.easyclick.agent</string>
            <key>CFBundleName</key>
            <string>EasyClick Agent</string>
            <key>CFBundleDisplayName</key>
            <string>EasyClick Agent</string>
            <key>CFBundleVersion</key>
            <string>5.12.0</string>
            <key>CFBundleShortVersionString</key>
            <string>5.12.0</string>
            <key>CFBundleExecutable</key>
            <string>EasyClickAgent</string>
            <key>UIBackgroundModes</key>
            <array>
                <string>background-fetch</string>
                <string>background-processing</string>
            </array>
        </dict>
        </plist>
        EOF
            
            # å¦‚æœæœ‰WebDriverAgentRunnerï¼Œå¤åˆ¶ç›¸å…³æ–‡ä»¶
            if [ -d "WebDriverAgentRunner" ]; then
                echo "ğŸ“ å¤åˆ¶WebDriverAgentRunneræ–‡ä»¶..."
                cp -r WebDriverAgentRunner/* Payload/EasyClickAgent.app/ || true
            fi
            
            # åˆ›å»ºç®€å•çš„å¯æ‰§è¡Œæ–‡ä»¶
            echo '#!/bin/bash\necho "EasyClick Agent Started"' > Payload/EasyClickAgent.app/EasyClickAgent
            chmod +x Payload/EasyClickAgent.app/EasyClickAgent
            
            # æ‰“åŒ…IPA
            zip -r EasyClickAgent.ipa Payload/
            echo "âœ… IPAåˆ›å»ºå®Œæˆ: EasyClickAgent.ipa"
        fi
        
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: EasyClickAgent-IPA
        path: "*.ipa"
        retention-days: 30
        
    - name: Create Release
      if: github.event_name == 'push'
      uses: ncipollo/release-action@v1
      with:
        tag: v5.12.0-${{ github.run_number }}
        name: EasyClick Agent v5.12.0-${{ github.run_number }}
        body: |
          ğŸ‰ EasyClick TJ Agent ç¼–è¯‘å®Œæˆï¼
          
          ## ğŸ“± å®‰è£…è¯´æ˜
          1. ä¸‹è½½ EasyClickAgent.ipa æ–‡ä»¶
          2. ä½¿ç”¨ TrollStore å®‰è£…åˆ°iOSè®¾å¤‡
          
          ## âš™ï¸ ç¼–è¯‘ä¿¡æ¯
          - ç¼–è¯‘æ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - macOSç‰ˆæœ¬: Latest
          - Xcodeç‰ˆæœ¬: Latest Stable
          - åŸºäº: EasyClick TJ Agent 5.12.0
          
          ## ğŸ”— ç›¸å…³é“¾æ¥
          - [TrollStoreä¸‹è½½](https://github.com/opa334/TrollStore)
          - [å®‰è£…æ•™ç¨‹](https://github.com/opa334/TrollStore#installation)
        artifacts: "*.ipa"
        token: ${{ secrets.GITHUB_TOKEN }}
        allowUpdates: true
