name: Build EasyClick TJ Agent

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Build EasyClick Agent
      run: |
        echo "🔨 开始编译EasyClick TJ Agent..."
        
        # 检查文件结构
        ls -la
        
        # 如果存在buildipa.sh，使用它
        if [ -f "buildipa.sh" ]; then
            echo "✅ 发现构建脚本，开始编译..."
            chmod +x buildipa.sh
            ./buildipa.sh
        else
            echo "📦 创建基础IPA包..."
            
            # 创建基础应用结构
            mkdir -p Payload/EasyClickAgent.app
            
            # 创建Info.plist
            cat > Payload/EasyClickAgent.app/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleIdentifier</key>
            <string>com.easyclick.agent</string>
            <key>CFBundleName</key>
            <string>EasyClick Agent</string>
            <key>CFBundleDisplayName</key>
            <string>EasyClick Agent</string>
            <key>CFBundleVersion</key>
            <string>5.12.0</string>
            <key>CFBundleShortVersionString</key>
            <string>5.12.0</string>
            <key>CFBundleExecutable</key>
            <string>EasyClickAgent</string>
            <key>UIBackgroundModes</key>
            <array>
                <string>background-fetch</string>
                <string>background-processing</string>
            </array>
        </dict>
        </plist>
        EOF
            
            # 如果有WebDriverAgentRunner，复制相关文件
            if [ -d "WebDriverAgentRunner" ]; then
                echo "📁 复制WebDriverAgentRunner文件..."
                cp -r WebDriverAgentRunner/* Payload/EasyClickAgent.app/ || true
            fi
            
            # 创建简单的可执行文件
            echo '#!/bin/bash\necho "EasyClick Agent Started"' > Payload/EasyClickAgent.app/EasyClickAgent
            chmod +x Payload/EasyClickAgent.app/EasyClickAgent
            
            # 打包IPA
            zip -r EasyClickAgent.ipa Payload/
            echo "✅ IPA创建完成: EasyClickAgent.ipa"
        fi
        
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: EasyClickAgent-IPA
        path: "*.ipa"
        retention-days: 30
        
    - name: Create Release
      if: github.event_name == 'push'
      uses: ncipollo/release-action@v1
      with:
        tag: v5.12.0-${{ github.run_number }}
        name: EasyClick Agent v5.12.0-${{ github.run_number }}
        body: |
          🎉 EasyClick TJ Agent 编译完成！
          
          ## 📱 安装说明
          1. 下载 EasyClickAgent.ipa 文件
          2. 使用 TrollStore 安装到iOS设备
          
          ## ⚙️ 编译信息
          - 编译时间: ${{ github.event.head_commit.timestamp }}
          - macOS版本: Latest
          - Xcode版本: Latest Stable
          - 基于: EasyClick TJ Agent 5.12.0
          
          ## 🔗 相关链接
          - [TrollStore下载](https://github.com/opa334/TrollStore)
          - [安装教程](https://github.com/opa334/TrollStore#installation)
        artifacts: "*.ipa"
        token: ${{ secrets.GITHUB_TOKEN }}
        allowUpdates: true
