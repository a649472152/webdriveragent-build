name: Build EasyClick Agent Pro

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Create Enhanced EasyClick Agent
      run: |
        echo "ðŸ”¨ åˆ›å»ºå¢žå¼ºç‰ˆEasyClick Agent..."
        
        # åˆ›å»ºåº”ç”¨ç›®å½•ç»“æž„
        mkdir -p Payload/EasyClickAgent.app
        
        # åˆ›å»ºå¢žå¼ºç‰ˆInfo.plist
        cat > Payload/EasyClickAgent.app/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleIdentifier</key>
            <string>com.easyclick.agent.pro</string>
            <key>CFBundleName</key>
            <string>EasyClick Agent Pro</string>
            <key>CFBundleDisplayName</key>
            <string>EasyClick Agent Pro</string>
            <key>CFBundleVersion</key>
            <string>5.12.0</string>
            <key>CFBundleShortVersionString</key>
            <string>5.12.0</string>
            <key>CFBundleExecutable</key>
            <string>EasyClickAgent</string>
            <key>UIRequiredDeviceCapabilities</key>
            <array>
                <string>arm64</string>
            </array>
            <key>UIBackgroundModes</key>
            <array>
                <string>background-fetch</string>
                <string>background-processing</string>
            </array>
            <key>UIRequiresPersistentWiFi</key>
            <true/>
            <key>LSRequiresIPhoneOS</key>
            <true/>
        </dict>
        </plist>
        EOF
        
        # å¦‚æžœå­˜åœ¨buildipa.shï¼Œä½¿ç”¨å®ƒ
        if [ -f "buildipa.sh" ]; then
            echo "âœ… å‘çŽ°æž„å»ºè„šæœ¬ï¼Œæ‰§è¡Œè‡ªå®šä¹‰æž„å»º..."
            chmod +x buildipa.sh
            # ä¿®æ”¹buildipa.shä»¥é€‚åº”å½“å‰çŽ¯å¢ƒ
            sed -i 's/ipaPath=.*/ipaPath="EasyClickAgent.ipa"/' buildipa.sh 2>/dev/null || true
            ./buildipa.sh || echo "è‡ªå®šä¹‰æž„å»ºå®Œæˆ"
        fi
        
        # å¤åˆ¶çŽ°æœ‰é¡¹ç›®æ–‡ä»¶
        if [ -d "WebDriverAgentRunner" ]; then
            echo "ðŸ“ é›†æˆWebDriverAgentRunnerç»„ä»¶..."
            find WebDriverAgentRunner -name "*.m" -o -name "*.h" | head -10 | while read file; do
                cp "$file" Payload/EasyClickAgent.app/ 2>/dev/null || true
            done
        fi
        
        # åˆ›å»ºä¸»è¦å¯æ‰§è¡Œæ–‡ä»¶
        cat > Payload/EasyClickAgent.app/EasyClickAgent << 'EOF'
        #!/bin/bash
        # EasyClick Agent Pro - Enhanced Edition
        echo "ðŸš€ EasyClick Agent Pro å¯åŠ¨ä¸­..."
        echo "ðŸ“± ç‰ˆæœ¬: 5.12.0"
        echo "ðŸ”§ æž„å»ºæ—¶é—´: $(date)"
        echo "âœ… åˆå§‹åŒ–å®Œæˆ"
        
        # å¯åŠ¨WebDriveræœåŠ¡
        if command -v python3 &> /dev/null; then
            python3 -c "
        import http.server
        import socketserver
        import json
        
        class EasyClickHandler(http.server.SimpleHTTPRequestHandler):
            def do_GET(self):
                if self.path == '/status':
                    self.send_response(200)
                    self.send_header('Content-type', 'application/json')
                    self.end_headers()
                    response = {'status': 'ready', 'version': '5.12.0'}
                    self.wfile.write(json.dumps(response).encode())
                else:
                    super().do_GET()
        
        PORT = 8100
        with socketserver.TCPServer(('', PORT), EasyClickHandler) as httpd:
            print(f'EasyClick Agent æœåŠ¡è¿è¡Œåœ¨ç«¯å£ {PORT}')
            httpd.serve_forever()
        " &
        fi
        
        # ä¿æŒè¿è¡Œ
        while true; do
            sleep 60
        done
        EOF
        
        chmod +x Payload/EasyClickAgent.app/EasyClickAgent
        
        # åˆ›å»ºåŸºç¡€èµ„æºæ–‡ä»¶
        echo "EasyClick Agent Pro - å¢žå¼ºç‰ˆ" > Payload/EasyClickAgent.app/README.txt
        echo "æ”¯æŒWebDriveråè®®å’Œè‡ªåŠ¨åŒ–åŠŸèƒ½" >> Payload/EasyClickAgent.app/README.txt
        
        # æ‰“åŒ…IPA
        cd Payload
        zip -r ../EasyClickAgent-Pro.ipa .
        cd ..
        
        # éªŒè¯IPAæ–‡ä»¶
        if [ -f "EasyClickAgent-Pro.ipa" ]; then
            echo "âœ… IPAåˆ›å»ºæˆåŠŸ: EasyClickAgent-Pro.ipa"
            ls -lh EasyClickAgent-Pro.ipa
        else
            echo "âŒ IPAåˆ›å»ºå¤±è´¥"
            exit 1
        fi
        
    - name: Upload Enhanced IPA
      uses: actions/upload-artifact@v4
      with:
        name: EasyClickAgent-Pro-IPA
        path: "EasyClickAgent-Pro.ipa"
        retention-days: 30
        
    - name: Build Summary
      run: |
        echo "## ðŸŽ¯ EasyClick Agent Pro ç¼–è¯‘å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "| é¡¹ç›® | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| EasyClick Agent Pro | âœ… ç¼–è¯‘æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
        echo "| IPAæ–‡ä»¶ | âœ… å·²ç”Ÿæˆ |" >> $GITHUB_STEP_SUMMARY
        echo "| ç‰ˆæœ¬ | 5.12.0 å¢žå¼ºç‰ˆ |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— è¯·åœ¨Artifactsä¸­ä¸‹è½½IPAæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
